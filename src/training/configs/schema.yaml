$schema: "https://json-schema.org/draft/2020-12/schema"
$id: "training-config.schema.json"
title: "Training Config Schema"
type: object
additionalProperties: false
required:
  - training

properties:
  base_model:
    type: string
    description: "Base model id/path for continual pretraining or SBERT finetuning."
    examples:
      - answerdotai/ModernBERT-base
      - /path/to/local/model

  tokenizer:
    type: object
    description: "Tokenizer settings for base-model MLM training."
    additionalProperties: false
    properties:
      name_or_path:
        type: string
        description: "Tokenizer id/path to load with AutoTokenizer."
        examples:
          - answerdotai/ModernBERT-base
      use_fast:
        type: boolean
        description: "Use fast tokenizer implementation when available."
        examples: [true]
      trust_remote_code:
        type: boolean
        description: "Allow custom remote code during tokenizer/model loading."
        examples: [false]

  model_class:
    type: string
    description: "Model variant name."
    enum:
      - frankenstein
      - mini
    examples:
      - frankenstein
      - mini

  model:
    type: object
    description: "UltraConfig model parameters."
    additionalProperties: false
    required:
      - vocab_size
      - hidden_size
      - num_layers
      - num_loops
      - num_heads
      - retention_heads
      - num_experts
      - top_k_experts
      - dropout
      - layer_pattern
      - ode_solver
      - ode_steps
      - use_bitnet
      - norm_type
      - use_factorized_embedding
      - factorized_embedding_dim
      - use_embedding_conv
      - embedding_conv_kernel
      - use_hope
      - use_moe
      - ffn_hidden_size
      - ffn_activation
    properties:
      vocab_size:
        type: integer
        minimum: 1
        description: "Vocabulary size."
        examples: [50000]
      hidden_size:
        type: integer
        minimum: 1
        description: "Hidden dimension."
        examples: [768]
      num_layers:
        type: integer
        minimum: 1
        description: "Physical layer count."
        examples: [12]
      num_loops:
        type: integer
        minimum: 1
        description: "Logical loop count."
        examples: [1, 2]
      num_heads:
        type: integer
        minimum: 1
        description: "Attention heads."
        examples: [12]
      retention_heads:
        type: integer
        minimum: 1
        description: "Retention heads."
        examples: [12]
      num_experts:
        type: integer
        minimum: 1
        description: "MoE expert count."
        examples: [4]
      top_k_experts:
        type: integer
        minimum: 1
        description: "Top-k experts for routing."
        examples: [2]
      dropout:
        type: number
        minimum: 0.0
        maximum: 1.0
        description: "Global dropout."
        examples: [0.1]
      layer_pattern:
        type: array
        minItems: 1
        description: "Ordered layer pattern."
        items:
          type: string
          enum: [retnet, mamba, ode, titan_attn, standard_attn, sigmoid_attn]
        examples:
          - [retnet, titan_attn, retnet, mamba, titan_attn, ode]
          - [standard_attn]
      ode_solver:
        type: string
        enum: [rk4, euler]
        description: "ODE integrator."
        examples: [rk4]
      ode_steps:
        type: integer
        minimum: 1
        description: "ODE integration steps."
        examples: [2]
      use_bitnet:
        type: boolean
        description: "Enable BitLinear."
        examples: [false]
      norm_type:
        type: string
        enum: [layer_norm, dynamic_tanh, derf]
        description: "Normalization type."
        examples: [layer_norm]
      use_factorized_embedding:
        type: boolean
        description: "Enable factorized embeddings."
        examples: [false]
      factorized_embedding_dim:
        type: integer
        minimum: 1
        description: "Reduced embedding dimension."
        examples: [128]
      use_embedding_conv:
        type: boolean
        description: "Enable Conv1d on embeddings."
        examples: [false]
      embedding_conv_kernel:
        type: integer
        minimum: 1
        description: "Conv1d kernel size."
        examples: [3]
      hope_base:
        type: number
        minimum: 0.0
        description: "HoPE base value."
        examples: [10000.0]
      hope_damping:
        type: number
        minimum: 0.0
        description: "HoPE damping."
        examples: [0.01]
      use_hope:
        type: boolean
        description: "Apply HoPE in titan_attn."
        examples: [true]
      use_moe:
        type: boolean
        description: "Enable MoE in FFN."
        examples: [true]
      ffn_hidden_size:
        type: integer
        minimum: 1
        description: "FFN intermediate dimension."
        examples: [3072]
      ffn_activation:
        type: string
        enum: [silu, gelu]
        description: "FFN activation function."
        examples: [gelu]

  training:
    type: object
    description: "TrainingConfig + runtime parameters."
    additionalProperties: false
    required:
      - task
    properties:
      task:
        type: string
        enum: [mlm, sbert]
        description: "Training task selector."
        examples: [mlm]
      num_epochs:
        type: integer
        minimum: 1
        description: "Number of training epochs for MLM task."
        examples: [5]
      batch_size:
        type: integer
        minimum: 1
        description: "Dataloader batch size."
        examples: [4]
      dataloader_workers:
        type: integer
        minimum: 0
        description: "Dataloader workers."
        examples: [2]
      max_length:
        type: integer
        minimum: 1
        description: "Max sequence length."
        examples: [512]
      mlm_probability:
        type: number
        minimum: 0.0
        maximum: 1.0
        description: "MLM mask probability."
        examples: [0.15]
      max_samples:
        type: integer
        minimum: 1
        description: "Max samples to stream."
        examples: [20000000]
      dataset_batch_size:
        type: integer
        minimum: 1
        description: "Streaming dataset internal batch size."
        examples: [25000]
      num_workers:
        type: integer
        minimum: 0
        description: "Streaming dataset workers."
        examples: [8]
      cache_dir:
        type: string
        description: "Cache directory."
        examples: ["./temp_data/v2_dataset_cache"]
      local_parquet_dir:
        type: string
        description: "Local parquet path (optional)."
        examples: ["/path/to/parquet"]
      prefer_local_cache:
        type: boolean
        description: "Prefer local cache when available."
        examples: [true]
      stream_local_parquet:
        type: boolean
        description: "Stream from local parquet if enabled."
        examples: [true]
      join_temp_data_context_window:
        type: integer
        minimum: 0
        description: "If >0, join cached temp_data token chunks into this context window length."
        examples: [0, 2000, 8192]
      join_temp_data_min_remainder_tokens:
        type: integer
        minimum: 1
        description: "Minimum remainder content tokens needed to keep the last partial joined window."
        examples: [128]
      use_amp:
        type: boolean
        description: "Enable mixed precision."
        examples: [false]
      gradient_accumulation_steps:
        type: integer
        minimum: 1
        description: "Gradient accumulation steps."
        examples: [4]
      optimizer:
        type: object
        description: "Optimizer chooser with prefixed hyperparameters."
        additionalProperties: false
        required:
          - optimizer_class
          - parameters
        properties:
          optimizer_class:
            type: string
            enum:
              - sgd_momentum
              - adamw
              - adafactor
              - galore_adamw
              - prodigy
              - lion
              - sophia
              - muon
              - turbo_muon
              - radam
              - adan
              - adopt
              - ademamix
              - mars_adamw
              - cautious_adamw
              - lamb
              - schedulefree_adamw
              - shampoo
              - soap
            description: "Optimizer id."
            examples: [adamw]
          parameters:
            type: object
            description: "Optimizer parameters prefixed with '<optimizer_class>-'. Available parameters for each optimizer are documented in x_parameter_reference."
            minProperties: 1
            additionalProperties: true
            x_parameter_reference:
              shared_per_group_suffixes:
                - lr_embeddings
                - lr_norms
                - lr_ode
                - lr_retnet
                - lr_mamba
                - lr_attention
                - lr_other
                - wd_embeddings
                - wd_norms
                - wd_ode
                - wd_retnet
                - wd_mamba
                - wd_attention
                - wd_other
                - betas_embeddings
                - betas_norms
                - betas_ode
                - betas_retnet
                - betas_mamba
                - betas_attention
                - betas_other
                - eps_embeddings
                - eps_norms
                - eps_ode
                - eps_retnet
                - eps_mamba
                - eps_attention
                - eps_other
              by_optimizer:
                sgd_momentum:
                  prefix: "sgd_momentum-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: [momentum, nesterov]
                adamw:
                  prefix: "adamw-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                adafactor:
                  prefix: "adafactor-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: [beta2_decay, clip_threshold, eps1, eps2]
                galore_adamw:
                  prefix: "galore_adamw-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: [rank, update_proj_gap]
                prodigy:
                  prefix: "prodigy-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: [d_coef]
                lion:
                  prefix: "lion-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                sophia:
                  prefix: "sophia-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: [rho, update_k]
                muon:
                  prefix: "muon-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: [momentum, nesterov, ns_steps, ns_eps]
                turbo_muon:
                  prefix: "turbo_muon-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: [momentum, nesterov, ns_steps, ns_eps]
                radam:
                  prefix: "radam-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                adan:
                  prefix: "adan-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                adopt:
                  prefix: "adopt-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                ademamix:
                  prefix: "ademamix-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                mars_adamw:
                  prefix: "mars_adamw-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                cautious_adamw:
                  prefix: "cautious_adamw-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: [cautious_clip]
                lamb:
                  prefix: "lamb-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                schedulefree_adamw:
                  prefix: "schedulefree_adamw-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                shampoo:
                  prefix: "shampoo-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
                soap:
                  prefix: "soap-"
                  supports_shared_per_group_suffixes: true
                  specific_global_suffixes: []
      scheduler_total_steps:
        type: integer
        minimum: 1
        description: "Total steps for scheduler."
        examples: [10000]
      scheduler_warmup_ratio:
        type: number
        minimum: 0.0
        maximum: 1.0
        description: "Warmup fraction of total steps."
        examples: [0.1]
      scheduler_type:
        type: string
        enum: [cosine, constant, linear_warmup_then_constant]
        description: "Scheduler type."
        examples: [cosine]
      grad_clip_max_norm:
        type: number
        minimum: 0.0
        description: "Gradient clipping max norm."
        examples: [5.0]
      inf_post_clip_threshold:
        type: number
        minimum: 0.0
        description: "Post-clip exploding gradient threshold."
        examples: [100.0]
      max_nan_retries:
        type: integer
        minimum: 0
        description: "Max retries for NaN handling."
        examples: [3]
      checkpoint_every_n_steps:
        type: integer
        minimum: 1
        description: "Checkpoint frequency in steps."
        examples: [500]
      max_rolling_checkpoints:
        type: integer
        minimum: 1
        description: "Rolling checkpoints to keep."
        examples: [3]
      num_best_checkpoints:
        type: integer
        minimum: 1
        description: "Best checkpoints to keep."
        examples: [2]
      nan_check_interval:
        type: integer
        minimum: 1
        description: "NaN/Inf check interval."
        examples: [10]
      log_gradient_stats:
        type: boolean
        description: "Enable gradient logging."
        examples: [true]
      gradient_log_interval:
        type: integer
        minimum: 1
        description: "Gradient logging interval."
        examples: [10]
      csv_log_path:
        type: string
        description: "CSV path for step-level training metrics."
        examples: ["training_metrics.csv"]
      csv_rotate_on_schema_change:
        type: boolean
        description: "Rotate existing CSV when logging schema changes."
        examples: [true]
      gpu_metrics_backend:
        type: string
        enum: [nvml, none]
        description: "GPU telemetry backend."
        examples: [nvml]
      nvml_device_index:
        type: integer
        minimum: 0
        description: "GPU index used for NVML telemetry."
        examples: [0]
      enable_block_grad_norms:
        type: boolean
        description: "Enable per-block gradient norm aggregation in CSV logs."
        examples: [true]
      telemetry_log_interval:
        type: integer
        minimum: 1
        description: "Interval (optimizer steps) for heavy telemetry and block grad norms."
        examples: [1]
      use_galore:
        type: boolean
        description: "Enable GaLore."
        examples: [false]
      galore_rank:
        type: integer
        minimum: 1
        description: "GaLore low-rank projection."
        examples: [64]
      galore_update_interval:
        type: integer
        minimum: 1
        description: "GaLore update interval."
        examples: [1]
      galore_scale:
        type: number
        minimum: 0.0
        description: "GaLore gradient scale."
        examples: [1.0]
      galore_max_dim:
        type: integer
        minimum: 1
        description: "Max tensor dimension for GaLore."
        examples: [4096]
      hf_output_dir:
        type: string
        description: "Output directory for save_pretrained artifacts when base_model is used."
        examples: ["checkpoints/hf_final"]
      sbert:
        type: object
        description: "SBERT task settings (used when training.task=sbert)."
        additionalProperties: false
        properties:
          dataset_name:
            type: string
            examples: ["erickfmm/agentlans__multilingual-sentences__paired_10_sts"]
          output_dir:
            type: string
            examples: ["./output/sbert_base_model"]
          batch_size:
            type: integer
            minimum: 1
            examples: [16]
          epochs:
            type: integer
            minimum: 1
            examples: [4]
          warmup_steps:
            type: integer
            minimum: 0
            examples: [1000]
          evaluation_steps:
            type: integer
            minimum: 1
            examples: [5000]
          learning_rate:
            type: number
            minimum: 0.0
            examples: [2.0e-5]
          max_train_samples:
            type: integer
            minimum: 1
          max_eval_samples:
            type: integer
            minimum: 1
            examples: [10000]
          max_seq_length:
            type: integer
            minimum: 1
            examples: [512]
          pooling_mode:
            type: string
            enum: [mean, cls, max]
            examples: [mean]
          trust_remote_code:
            type: boolean
            examples: [false]
          use_amp:
            type: boolean
            examples: [true]
          resample_balanced:
            type: boolean
            examples: [true]
          resample_std:
            type: number
            minimum: 0.0
            examples: [0.3]
    allOf:
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: sgd_momentum
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^sgd_momentum-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: adamw
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^adamw-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: adafactor
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^adafactor-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: galore_adamw
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^galore_adamw-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: prodigy
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^prodigy-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: lion
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^lion-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: sophia
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^sophia-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: muon
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^muon-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: turbo_muon
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^turbo_muon-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: radam
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^radam-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: adan
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^adan-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: adopt
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^adopt-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: ademamix
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^ademamix-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: mars_adamw
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^mars_adamw-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: cautious_adamw
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^cautious_adamw-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: lamb
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^lamb-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: schedulefree_adamw
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^schedulefree_adamw-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: shampoo
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^shampoo-": {}
      - if:
          properties:
            optimizer:
              properties:
                optimizer_class:
                  const: soap
        then:
          properties:
            optimizer:
              properties:
                parameters:
                  additionalProperties: false
                  patternProperties:
                    "^soap-": {}

allOf:
  - anyOf:
      - required: [base_model]
      - required: [model_class, model]
  - if:
      properties:
        training:
          properties:
            task:
              const: mlm
    then:
      properties:
        training:
          required: [optimizer]
  - if:
      properties:
        training:
          properties:
            task:
              const: sbert
    then:
      properties:
        training:
          required: [sbert]
  - if:
      required: [base_model]
    then:
      properties:
        training:
          required:
            - task
      allOf:
        - if:
            properties:
              training:
                properties:
                  task:
                    const: mlm
          then:
            properties:
              tokenizer:
                required: [name_or_path]
  - if:
      not:
        required: [base_model]
    then:
      required: [model_class, model]

examples:
  - model_class: frankenstein
    model:
      vocab_size: 50000
      hidden_size: 768
      num_layers: 12
      num_loops: 1
      num_heads: 12
      retention_heads: 12
      num_experts: 4
      top_k_experts: 2
      dropout: 0.1
      layer_pattern: [standard_attn]
      ode_solver: rk4
      ode_steps: 2
      use_bitnet: false
      norm_type: layer_norm
      use_factorized_embedding: false
      factorized_embedding_dim: 128
      use_embedding_conv: false
      embedding_conv_kernel: 3
      use_hope: false
      use_moe: false
      ffn_hidden_size: 3072
      ffn_activation: gelu
    training:
      task: mlm
      batch_size: 4
      dataloader_workers: 2
      max_length: 512
      mlm_probability: 0.15
      max_samples: 20000000
      dataset_batch_size: 25000
      num_workers: 8
      cache_dir: "./temp_data/v2_dataset_cache"
      use_amp: false
      gradient_accumulation_steps: 4
      optimizer:
        optimizer_class: adamw
        parameters:
          adamw-lr_embeddings: 1e-6
          adamw-lr_norms: 5e-6
          adamw-lr_ode: 1e-7
          adamw-lr_retnet: 5e-6
          adamw-lr_mamba: 2e-6
          adamw-lr_attention: 3e-6
          adamw-lr_other: 2e-6
          adamw-wd_embeddings: 0.01
          adamw-wd_norms: 0.001
          adamw-wd_ode: 0.01
          adamw-wd_retnet: 0.01
          adamw-wd_mamba: 0.01
          adamw-wd_attention: 0.01
          adamw-wd_other: 0.01
          adamw-betas_embeddings: [0.9, 0.95]
          adamw-betas_norms: [0.9, 0.95]
          adamw-betas_ode: [0.9, 0.95]
          adamw-betas_retnet: [0.9, 0.95]
          adamw-betas_mamba: [0.9, 0.95]
          adamw-betas_attention: [0.9, 0.95]
          adamw-betas_other: [0.9, 0.95]
          adamw-eps_embeddings: 1e-8
          adamw-eps_norms: 1e-8
          adamw-eps_ode: 1e-8
          adamw-eps_retnet: 1e-8
          adamw-eps_mamba: 1e-8
          adamw-eps_attention: 1e-8
          adamw-eps_other: 1e-8
      scheduler_total_steps: 10000
      scheduler_warmup_ratio: 0.1
      scheduler_type: cosine
      grad_clip_max_norm: 5.0
      inf_post_clip_threshold: 100.0
      max_nan_retries: 3
      checkpoint_every_n_steps: 500
      max_rolling_checkpoints: 3
      num_best_checkpoints: 2
      nan_check_interval: 10
      log_gradient_stats: true
      gradient_log_interval: 10
      csv_log_path: "training_metrics.csv"
      csv_rotate_on_schema_change: true
      gpu_metrics_backend: nvml
      nvml_device_index: 0
      enable_block_grad_norms: true
      telemetry_log_interval: 1
      use_galore: false
      galore_rank: 64
      galore_update_interval: 1
      galore_scale: 1.0
      galore_max_dim: 4096
